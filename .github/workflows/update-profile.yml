name: Update Profile Metrics
on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Generate metrics SVG
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          user: xiaoshecode
          template: classic
          filename: metrics.svg
          config_timezone: Asia/Shanghai
          base: header, repositories
          sections: activity, community, repositories
          plugin_languages: yes
          plugin_languages_limit: 6
          plugin_languages_sections: recently-used
          plugin_languages_threshold: 2%
      - name: Inject metrics into README
        run: |
          sed -i '/<!-- METRICS_START -->/,/<!-- METRICS_END -->/c\\<!-- METRICS_START -->\n<img src="metrics.svg" alt="Metrics" width="600"/>\n<!-- METRICS_END -->' README.md
      - name: Commit changes
        run: |
          git config user.name 'github-actions'
          git config user.email 'actions@users.noreply.github.com'
          git add README.md metrics.svg
          git commit -m 'chore: update metrics' || echo 'No changes to commit'
          git push
  activity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fetch recent public events
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const username = 'xiaoshecode';
            const events = await github.request('GET /users/{username}/events/public', { username });
            const picked = events.data.filter(e => ['PushEvent','PullRequestEvent','IssuesEvent'].includes(e.type)).slice(0,7).map(e => {
              if(e.type==='PushEvent') {
                const msg = e.payload.commits?.[0]?.message || 'push';
                return `- üî® Push: ${e.repo.name} ‚Äî ${msg}`;
              }
              if(e.type==='PullRequestEvent') {
                return `- üîÑ PR: ${e.repo.name} #${e.payload.pull_request.number} (${e.payload.action})`;
              }
              if(e.type==='IssuesEvent') {
                return `- ‚ùó Issue: ${e.repo.name} #${e.payload.issue.number} (${e.payload.action})`;
              }
              return `- üìå ${e.type}: ${e.repo.name}`;
            });
            const path = 'README.md';
            let md = fs.readFileSync(path,'utf8');
            md = md.replace(/<!-- ACTIVITY_START -->[\s\S]*<!-- ACTIVITY_END -->/,
              `<!-- ACTIVITY_START -->\n${picked.join('\n')}\n<!-- ACTIVITY_END -->`);
            fs.writeFileSync(path, md);
      - name: Commit activity block
        run: |
          git config user.name 'github-actions'
          git config user.email 'actions@users.noreply.github.com'
          git add README.md
          git commit -m 'chore: update recent activity' || echo 'No changes'
          git push
  papers:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate recent paper summaries (arXiv quant-ph)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const fetch = require('node-fetch');
            const api = 'https://export.arxiv.org/api/query?search_query=cat:quant-ph&start=0&max_results=5&sortBy=submittedDate&sortOrder=descending';
            const xml = await fetch(api).then(r=>r.text());
            // Quick & dirty parsing for titles (avoid heavy deps)
            const titles = [...xml.matchAll(/<title>([^<]+)<\/title>/g)].slice(1).map(m=>m[1]);
            const lines = titles.map(t => `- üß™ ${t.substring(0,120)}${t.length>120?'‚Ä¶':''}`);
            let md = fs.readFileSync('README.md','utf8');
            md = md.replace(/<!-- PAPERS_START -->[\s\S]*<!-- PAPERS_END -->/,
              `<!-- PAPERS_START -->\n${lines.join('\n')}\n<!-- PAPERS_END -->`);
            fs.writeFileSync('README.md', md);
      - name: Commit paper summaries
        run: |
          git config user.name 'github-actions'
          git config user.email 'actions@users.noreply.github.com'
          git add README.md
          git commit -m 'chore: update paper summaries' || echo 'No changes'
          git push
